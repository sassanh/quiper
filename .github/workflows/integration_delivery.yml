name: CI/CD

on:
  push:
    branches:
      - main
      - development
    tags:
      - "v*"
  pull_request:
  schedule:
    - cron: "0 0 * * *"

jobs:
  build:
    name: Build
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Build Swift App
        run: ./build-app.sh
      - name: Compress App
        run: ditto -c -k --sequesterRsrc --keepParent Quiper.app Quiper.app.zip
      - name: Upload App
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: Quiper.app.zip
          if-no-files-found: error

  nightly-release:
    if: github.event_name == 'schedule'
    name: Nightly Pre-release
    runs-on: macos-latest
    needs:
      - build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: app
          path: artifacts
      - name: Generate Nightly Tag
        id: generate_tag
        run: echo "TAG_NAME=nightly-$(date +'%Y-%m-%d-%H%M')" >>"$GITHUB_OUTPUT"
      - name: Create Nightly Pre-release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          tag_name: ${{ steps.generate_tag.outputs.TAG_NAME }}
          name: Nightly Build ${{ steps.generate_tag.outputs.TAG_NAME }}
          body: "Nightly pre-release build. For testing purposes only."
          prerelease: true
          draft: false

  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    name: Publish Release
    runs-on: macos-latest
    needs:
      - build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: app
          path: artifacts
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: "Automated release for ${{ github.ref_name }}."
          draft: false
          prerelease: false
