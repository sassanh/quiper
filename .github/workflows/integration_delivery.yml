name: CI/CD

on:
  push:
    branches:
      - main
      - development
    tags:
      - "v*"
  pull_request:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

jobs:
  tests:
    name: Tests
    runs-on: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Toolchain info
        run: |
          swift --version
          xcodebuild -version

      - name: Run tests
        run: swift test --configuration debug --enable-code-coverage

      - name: Generate coverage HTML
        run: |
          set -euo pipefail
          PROFILE=$(find .build -path "*/codecov/default.profdata" | head -n1)
          TEST_BIN=$(find .build -type f -path "*.xctest/Contents/MacOS/*" | head -n1)
          ROOT=$(pwd)
          xcrun llvm-cov show \
            "$TEST_BIN" \
            -instr-profile "$PROFILE" \
            -path-equivalence "$ROOT","." \
            -format=html \
            -output-dir coverage-html \
            "$ROOT/Sources"

      - name: Generate coverage JSON
        run: |
          set -euo pipefail
          PROFILE=$(find .build -path "*/codecov/default.profdata" | head -n1)
          if [ -z "$PROFILE" ]; then
            echo "No default.profdata found under .build/**/codecov"
            exit 1
          fi
          TEST_BIN=$(find .build -type f -path "*.xctest/Contents/MacOS/*" | head -n1)
          if [ -z "$TEST_BIN" ]; then
            echo "No test binary found under .build"
            exit 1
          fi
          ROOT=$(pwd)
          xcrun llvm-cov export \
            "$TEST_BIN" \
            -instr-profile "$PROFILE" \
            -path-equivalence "$ROOT/","." \
            -format=lcov \
            Sources >coverage.json

      - name: Coverage summary
        run: |
          set -euo pipefail
          PROFILE=$(find .build -path "*/codecov/default.profdata" | head -n1)
          TEST_BIN=$(find .build -type f -path "*.xctest/Contents/MacOS/*" | head -n1)
          ROOT=$(pwd)
          xcrun llvm-cov report \
            "$TEST_BIN" \
            -instr-profile="$PROFILE" \
            -path-equivalence "$ROOT","." \
            "$ROOT/Sources"

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage-html
          if-no-files-found: error

      - name: Upload coverage JSON to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.json
          fail_ci_if_error: true
          flags: unittests
          root_dir: ${{ github.workspace }}

  build:
    name: Build
    runs-on: macos-26
    needs: tests
    steps:
      - uses: actions/checkout@v4
      - name: Build Swift App
        run: ./build-app.sh
      - name: Compress App
        run: ditto -c -k --sequesterRsrc --keepParent Quiper.app Quiper.app.zip
      - name: Upload App
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: Quiper.app.zip
          if-no-files-found: error

  nightly-release:
    if: github.event_name == 'schedule'
    name: Nightly Pre-release
    runs-on: macos-latest
    needs:
      - build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: app
          path: artifacts
      - name: Generate Nightly Tag
        id: generate_tag
        run: echo "TAG_NAME=nightly-$(date +'%Y-%m-%d-%H%M')" >>"$GITHUB_OUTPUT"
      - name: Create Nightly Pre-release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          tag_name: ${{ steps.generate_tag.outputs.TAG_NAME }}
          name: Nightly Build ${{ steps.generate_tag.outputs.TAG_NAME }}
          body: "Nightly pre-release build. For testing purposes only."
          prerelease: true
          draft: false

  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    name: Publish Release
    runs-on: macos-latest
    needs:
      - build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: app
          path: artifacts
      - name: Determine Release Version
        id: release_version
        run: echo "value=${GITHUB_REF_NAME#v}" >>"$GITHUB_OUTPUT"
        shell: bash
      - name: Read changelog entry
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2
        with:
          version: ${{ steps.release_version.outputs.value }}
          path: ./CHANGELOG.md
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.changelog_reader.outputs.changes }}
          draft: false
          prerelease: false
